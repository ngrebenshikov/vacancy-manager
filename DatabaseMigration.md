# Введение #
Database-migration – средство которое позволяет производить изменение существующей модели БД без потери данных. Без потери в данном случае обозначает, что после обновления структуры БД не произойдёт потери всех данных. Потеря данных возможна только если мы сознательно удаляем определённый параметр из БД.
Для того чтобы работать с Database-migration в Entity Framework, нужно обновить последний до версии 4.3.1: это можно сделать через Package Manager Console в VS Web Developer командой: ```
Update-Package EntityFramework``` Либо же через диспетчер расширений, но в моём случае он говорил о неразрешимых зависимостях и требовал консольное обновление. Также в решении должна быть ссылка на Entity Framework.

Есть две разновидности миграций: Automatic Migrations и Code-Based Migrations

# Automatic migrations #
Вся дальнейшая работа с миграциями будет основана на Package Manager Console в студии и sqlcmd(её использование будет помечаться отдельно, если не указано явно считайте что мы работаем в PMC).

Для активирования механизма миграций необходимо ввести в консоли команду:
```
Enable-Migrations –EnableAutomaticMigrations(активирует автоматическую миграцию)```

В проекте будет создана папка Migrations, где будет дано описание миграций. Там будет создан файл Configuration.cs, в нём мы можем задать Db контексты, к которым можно будет применять миграции.

Если есть необходимость для адаптации БД к миграциям, которая была создана с помощью Entity <4.3.1 необходимо ввести команду:
```
Add-Migration InitialMigration –IgnoreChanges```

**Add-Migration** добавляет именованную миграцию, может понадобится для приведения БД к определённому виду.

Для изменения базы данных после изменения контекста используется команда: ```
Update-Database```
Ключи для данной команды:
  * **Force**: позволяет изменить БД, если после изменения будут утеряны некоторые столбцы.
  * **Verbose**: в консоль будет выведен sql запрос изменяющий БД.
  * **Script**: изменения в БД не будут внесены, вместо этого будет сгенерирован sql скрипт. Будьте внимательны, в скрипт может быть добавлен код создания таблицы Migrations, его нужно будет удалить.
  * **TargetMigration**: позволяет задать к какому виду привести БД, после этого параметра необходимо указать либо имя миграции, добавленное с помощью Add-Migration, либо $InitialDatabase для полной очистки базы(т.е будет удалены все данные, все столбцы, будет удалена даже dbo._MigrationHistory, которая позволяет вернуться предыдущим версиям БД, так что используйте это с осторожностью).
  * **SourceMigration**: Позволяет указать с какой версии БД произвести обновление._

# Code base migrations #
По вводимым командам данный тип миграций практически не отличается от AutomaticMigrations. Если при автоматических миграциях достаточно было изменить модель и обновить БД, то здесь необходимо вручную прописывать все изменения. Вручную в данном случае означает не sql запросы(хотя их тоже можно использовать), а такими функциями как DropColumn/AddColumn.
Для использования CodeBaseMigration:
Add-Migration ИмяМиграции.
В папке migrations будет создан cs файл, в котором будет описано какие действия необходимо произвести с базой при миграции к этой версии(Up метод) или ниже(Down) метод.
Обновление при кодовых миграция производится так:
```
Update-Database –TargetMigration:ИмяМиграции```

Использование sql скриптов для миграций:
Как уже говорилось мы можем создать sql скрипт для изменения БД.
Делается это так:
```
Update-Database –Script```А также необходимые ключи, такие как Target(Source)Migration/Force и другие. Будет сгенерирован sql скрипт, который мы можем изменить/сохранить. Будьте внимательны, в скрипт может быть добавлен код создания таблицы Migrations, его нужно будет удалить. Сохраняется он в папке Решение/obj/Debug/. !!!Обновления БД при этом не происходит!!!

Что же теперь делать с sql скриптом? Здесь два пути:
  1. Используя Sql Server Management Studio обновить БД, она имеет простой графический интерфейс, проблем не возникнет.
  1. Используя sqlcmd. Открываем командную строку, пишем в неё примерно следующее
```
sqlcmd -S ".\sqlexpress" -E -d "ИмяБазыДанных" -i "ПутьДоСкрипта\ИмяСкрипта.sql"```
Ключи:
  * **–S** указывает на используемый sql сервер(у меня это .\sqlexpress)
  * **-E** обозначает, что соединение является доверенным, и не будет производиться запроса имени пользователя и пароля. Насколько я понял производиться проверка подлинности Windows(не та которая про активацию).
  * **-d** указание имени БД
  * **-i** путь до sql скрипта
Для подключения по имени пользователя и паролю:
```
sqlcmd -S ".\sqlexpress" –U “ИмяПользователя” –p 1 -d "ИмяБазыДанных" -i "ПутьДоСкрипта\ИмяСкрипта.sql"```

  * **-U** задаёт имя пользователя
  * **-p 1** требуется ввод пароля.

# Что необходимо сделать если вы изменили модель #

Т.к. существует договорённость об использовании Code-Based миграций, необходимо сделать следующее(Если хотим обновляться через консоль студии):
  1. Add-Migration ИмяМиграцииОтражающееЕёСуть
  1. При необходимости отредактировать код миграции
  1. Update-Database -TargetMigration ИмяМиграции
  1. Добавить файл миграции под контроль версий, не забыв в коммите указать имя добавленой миграции

Если хотим обновляться через sql скрипты:
  1. Add-Migration ИмяМиграцииОтражающееЕёСуть
  1. При необходимости отредактировать код миграции
  1. Update-Database -TargetMigration ИмяМиграции -Script
  1. Редактируем sql скрипт и сохраняем его под именем миграции
  1. Добавить файл с sql скриптом и созданным миграционным файлом под контроль версий, не забыв в коммите указать имя добавленой миграции


# Другой разработчик поменял модель, как обновить свою #
Если хотим обновляться через консоль студии:
  1. Update-Database ИмяМиграции
Если хотим обновляться через sql скрипты:Обновиться с использованием sqlcmd, способ описан выше.

Есть ещё возможность применять миграции, которые описаны в cs файлах с помощью Migrate.exe. Но есть одна проблема, когда я через консоль дал ему указание применить миграцию происходило непонятно что, он писал что базу то обновил, но открыв её для просмотра, было видно никаких изменений не произошло. Если кто разберётся обновите статью. Синтаксис у команды следующий:
```

migrate.exe ИмяСборки /StartUpDirectory: "ПутьДоРешения\bin"
/connectionStringName: "ConnectionString из Web.config" /startUpConfigurationFile: "ПутьДоРешения\Web.config"
/targetMigration: "ИмяМиграции"```

Ссылки для более подробного ознакомления:
  1. <a href='http://andrey.moveax.ru/entity-framework/code-first/migrations-august-2011-ctp/'>Базовое представление.</a>
  1. <a href='http://www.ladislavmrnka.com/2012/03/ef-4-3-migrations-and-existing-database/'>Entity Framework 4.3 code first migrations with an existing database</a>
  1. <a href='http://blogs.msdn.com/b/adonet/archive/2012/02/09/ef-4-3-automatic-migrations-walkthrough.aspx'>Automatic Migrations</a>
  1. <a href='http://blogs.msdn.com/b/adonet/archive/2012/02/09/ef-4-3-code-based-migrations-walkthrough.aspx'> Code-Based Migrations</a>